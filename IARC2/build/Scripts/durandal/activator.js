define(["durandal/system","knockout"],function(e,t){function n(e){return void 0==e&&(e={}),e.closeOnDeactivate||(e.closeOnDeactivate=s.defaults.closeOnDeactivate),e.beforeActivate||(e.beforeActivate=s.defaults.beforeActivate),e.afterDeactivate||(e.afterDeactivate=s.defaults.afterDeactivate),e.affirmations||(e.affirmations=s.defaults.affirmations),e.interpretResponse||(e.interpretResponse=s.defaults.interpretResponse),e.areSameItem||(e.areSameItem=s.defaults.areSameItem),e}function a(t,n,a){return e.isArray(a)?t[n].apply(t,a):t[n](a)}function r(t,n,a,r,o){if(t&&t.deactivate){e.log("Deactivating",t);var g;try{g=t.deactivate(n)}catch(l){return e.error(l),r.resolve(!1),void 0}g&&g.then?g.then(function(){a.afterDeactivate(t,n,o),r.resolve(!0)},function(t){e.log(t),r.resolve(!1)}):(a.afterDeactivate(t,n,o),r.resolve(!0))}else t&&a.afterDeactivate(t,n,o),r.resolve(!0)}function o(t,n,r,o){if(t)if(t.activate){e.log("Activating",t);var g;try{g=a(t,"activate",o)}catch(l){return e.error(l),r(!1),void 0}g&&g.then?g.then(function(){n(t),r(!0)},function(t){e.log(t),r(!1)}):(n(t),r(!0))}else n(t),r(!0);else r(!0)}function g(t,n,a){return a.lifecycleData=null,e.defer(function(r){if(t&&t.canDeactivate){var o;try{o=t.canDeactivate(n)}catch(g){return e.error(g),r.resolve(!1),void 0}o.then?o.then(function(e){a.lifecycleData=e,r.resolve(a.interpretResponse(e))},function(t){e.error(t),r.resolve(!1)}):(a.lifecycleData=o,r.resolve(a.interpretResponse(o)))}else r.resolve(!0)}).promise()}function l(t,n,r,o){return r.lifecycleData=null,e.defer(function(g){if(t==n())return g.resolve(!0),void 0;if(t&&t.canActivate){var l;try{l=a(t,"canActivate",o)}catch(i){return e.error(i),g.resolve(!1),void 0}l.then?l.then(function(e){r.lifecycleData=e,g.resolve(r.interpretResponse(e))},function(t){e.error(t),g.resolve(!1)}):(r.lifecycleData=l,g.resolve(r.interpretResponse(l)))}else g.resolve(!0)}).promise()}function i(a,i){var s,d=t.observable(null);i=n(i);var p=t.computed({read:function(){return d()},write:function(e){p.viaSetter=!0,p.activateItem(e)}});return p.__activator__=!0,p.settings=i,i.activator=p,p.isActivating=t.observable(!1),p.canDeactivateItem=function(e,t){return g(e,t,i)},p.deactivateItem=function(t,n){return e.defer(function(e){p.canDeactivateItem(t,n).then(function(a){a?r(t,n,i,e,d):(p.notifySubscribers(),e.resolve(!1))})}).promise()},p.canActivateItem=function(e,t){return l(e,d,i,t)},p.activateItem=function(t,n){var a=p.viaSetter;return p.viaSetter=!1,e.defer(function(g){if(p.isActivating())return g.resolve(!1),void 0;p.isActivating(!0);var l=d();return i.areSameItem(l,t,s,n)?(p.isActivating(!1),g.resolve(!0),void 0):(p.canDeactivateItem(l,i.closeOnDeactivate).then(function(m){m?p.canActivateItem(t,n).then(function(m){m?e.defer(function(e){r(l,i.closeOnDeactivate,i,e)}).promise().then(function(){t=i.beforeActivate(t,n),o(t,d,function(e){s=n,p.isActivating(!1),g.resolve(e)},n)}):(a&&p.notifySubscribers(),p.isActivating(!1),g.resolve(!1))}):(a&&p.notifySubscribers(),p.isActivating(!1),g.resolve(!1))}),void 0)}).promise()},p.canActivate=function(){var e;return a?(e=a,a=!1):e=p(),p.canActivateItem(e)},p.activate=function(){var e;return a?(e=a,a=!1):e=p(),p.activateItem(e)},p.canDeactivate=function(e){return p.canDeactivateItem(p(),e)},p.deactivate=function(e){return p.deactivateItem(p(),e)},p.includeIn=function(e){e.canActivate=function(){return p.canActivate()},e.activate=function(){return p.activate()},e.canDeactivate=function(e){return p.canDeactivate(e)},e.deactivate=function(e){return p.deactivate(e)}},i.includeIn?p.includeIn(i.includeIn):a&&p.activate(),p.forItems=function(t){i.closeOnDeactivate=!1,i.determineNextItemToActivate=function(e,t){var n=t-1;return-1==n&&e.length>1?e[1]:n>-1&&n<e.length-1?e[n]:null},i.beforeActivate=function(e){var n=p();if(e){var a=t.indexOf(e);-1==a?t.push(e):e=t()[a]}else e=i.determineNextItemToActivate(t,n?t.indexOf(n):0);return e},i.afterDeactivate=function(e,n){n&&t.remove(e)};var n=p.canDeactivate;p.canDeactivate=function(a){return a?e.defer(function(e){function n(){for(var t=0;t<o.length;t++)if(!o[t])return e.resolve(!1),void 0;e.resolve(!0)}for(var r=t(),o=[],g=0;g<r.length;g++)p.canDeactivateItem(r[g],a).then(function(e){o.push(e),o.length==r.length&&n()})}).promise():n()};var a=p.deactivate;return p.deactivate=function(n){return n?e.defer(function(e){function a(a){p.deactivateItem(a,n).then(function(){o++,t.remove(a),o==g&&e.resolve()})}for(var r=t(),o=0,g=r.length,l=0;g>l;l++)a(r[l])}).promise():a()},p},p}var s,d={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(n){return e.isObject(n)&&(n=n.can||!1),e.isString(n)?-1!==t.utils.arrayIndexOf(this.affirmations,n.toLowerCase()):n},areSameItem:function(e,t){return e==t},beforeActivate:function(e){return e},afterDeactivate:function(e,t,n){t&&n&&n(null)}};return s={defaults:d,create:i,isActivator:function(e){return e&&e.__activator__}}});