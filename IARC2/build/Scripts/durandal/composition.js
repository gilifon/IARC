define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,t,n,a,r,o,g){function l(e){for(var t=[],n={childElements:t,activeView:null},a=g.virtualElements.firstChild(e);a;)1==a.nodeType&&(t.push(a),a.getAttribute(u)&&(n.activeView=a)),a=g.virtualElements.nextSibling(a);return n.activeView||(n.activeView=t[0]),n}function i(){b--,0===b&&setTimeout(function(){for(var e=v.length;e--;)v[e]();v=[]},1)}function s(t,n,a){if(a)n();else if(t.activate&&t.model&&t.model.activate){var r;r=e.isArray(t.activationData)?t.model.activate.apply(t.model,t.activationData):t.model.activate(t.activationData),r&&r.then?r.then(n):r||void 0===r?n():i()}else n()}function d(){var t=this;t.activeView&&t.activeView.removeAttribute(u),t.child&&(t.model&&t.model.attached&&(t.composingNewView||t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t),t.attached&&t.attached(t.child,t.parent,t),t.child.setAttribute(u,!0),t.composingNewView&&t.model&&(t.model.compositionComplete&&h.current.complete(function(){t.model.compositionComplete(t.child,t.parent,t)}),t.model.detached&&g.utils.domNodeDisposal.addDisposeCallback(t.child,function(){t.model.detached(t.child,t.parent,t)})),t.compositionComplete&&h.current.complete(function(){t.compositionComplete(t.child,t.parent,t)})),i(),t.triggerAttach=e.noop}function p(t){if(e.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var n=t.activeView.getAttribute("data-view"),a=t.child.getAttribute("data-view");return n!=a}}return!0}return!1}function m(e){for(var t=0,n=e.length,a=[];n>t;t++){var r=e[t].cloneNode(!0);a.push(r)}return a}function c(e){var t=m(e.parts),n=h.getParts(t),a=h.getParts(e.child);for(var r in n)o(a[r]).replaceWith(n[r])}function L(t){var n,a,r=g.virtualElements.childNodes(t);if(!e.isArray(r)){var o=[];for(n=0,a=r.length;a>n;n++)o[n]=r[n];r=o}for(n=1,a=r.length;a>n;n++)g.removeNode(r[n])}var h,w={},u="data-active-view",v=[],b=0,f="durandal-composition-data",y="data-part",_="["+y+"]",x=["model","view","transition","area","strategy","activationData"],S={complete:function(e){v.push(e)}};return h={convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:S,addBindingHandler:function(e,t,n){var a,r,o="composition-handler-"+e;t=t||g.bindingHandlers[e],n=n||function(){return void 0},r=g.bindingHandlers[e]={init:function(e,a,r,l,i){var s={trigger:g.observable(null)};return h.current.complete(function(){t.init&&t.init(e,a,r,l,i),t.update&&(g.utils.domData.set(e,o,t),s.trigger("trigger"))}),g.utils.domData.set(e,o,s),n(e,a,r,l,i)},update:function(e,t,n,a,r){var l=g.utils.domData.get(e,o);return l.update?l.update(e,t,n,a,r):(l.trigger(),void 0)}};for(a in t)"init"!==a&&"update"!==a&&(r[a]=t[a])},getParts:function(t){var n={};e.isArray(t)||(t=[t]);for(var a=0;a<t.length;a++){var r=t[a];if(r.getAttribute){var g=r.getAttribute(y);g&&(n[g]=r);for(var l=o(_,r).not(o("[data-bind] "+_,r)),i=0;i<l.length;i++){var s=l.get(i);n[s.getAttribute(y)]=s}}}return n},cloneNodes:m,finalize:function(t){if(t.transition=t.transition||this.defaultTransitionName,t.child||t.activeView)if(p(t)){var a=this.convertTransitionToModuleId(t.transition);e.acquire(a).then(function(e){t.transition=e,e(t).then(function(){if(t.cacheViews){if(t.activeView){var e=n.getBindingInstruction(t.activeView);void 0==e.cacheViews||e.cacheViews||g.removeNode(t.activeView)}}else t.child?L(t.parent):g.virtualElements.emptyNode(t.parent);t.triggerAttach()})}).fail(function(t){e.error("Failed to load transition ("+a+"). Details: "+t.message)})}else{if(t.child!=t.activeView){if(t.cacheViews&&t.activeView){var r=n.getBindingInstruction(t.activeView);void 0==r.cacheViews||r.cacheViews?o(t.activeView).hide():g.removeNode(t.activeView)}t.child?(t.cacheViews||L(t.parent),o(t.child).show()):t.cacheViews||g.virtualElements.emptyNode(t.parent)}t.triggerAttach()}else t.cacheViews||g.virtualElements.emptyNode(t.parent),t.triggerAttach()},bindAndShow:function(e,t,r){t.child=e,t.composingNewView=t.cacheViews?-1==g.utils.arrayIndexOf(t.viewElements,e):!0,s(t,function(){if(t.binding&&t.binding(t.child,t.parent,t),t.preserveContext&&t.bindingContext)t.composingNewView&&(t.parts&&c(t),o(e).hide(),g.virtualElements.prepend(t.parent,e),n.bindContext(t.bindingContext,e,t.model));else if(e){var r=t.model||w,l=g.dataFor(e);if(l!=r){if(!t.composingNewView)return o(e).remove(),a.createView(e.getAttribute("data-view")).then(function(e){h.bindAndShow(e,t,!0)}),void 0;t.parts&&c(t),o(e).hide(),g.virtualElements.prepend(t.parent,e),n.bind(r,e)}}h.finalize(t)},r)},defaultStrategy:function(e){return t.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(t){var n,o=t(),l=g.utils.unwrapObservable(o)||{},i=r.isActivator(o);if(e.isString(l))return l=a.isViewUrl(l)?{view:l}:{model:l,activate:!0};if(n=e.getModuleId(l))return l={model:l,activate:!0};!i&&l.model&&(i=r.isActivator(l.model));for(var s in l)l[s]=-1!=g.utils.arrayIndexOf(x,s)?g.utils.unwrapObservable(l[s]):l[s];return i?l.activate=!1:void 0===l.activate&&(l.activate=!0),l},executeStrategy:function(e){e.strategy(e).then(function(t){h.bindAndShow(t,e)})},inject:function(n){return n.model?n.view?(t.locateView(n.view,n.area,n.viewElements).then(function(e){h.bindAndShow(e,n)}),void 0):(n.strategy||(n.strategy=this.defaultStrategy),e.isString(n.strategy)?e.acquire(n.strategy).then(function(e){n.strategy=e,h.executeStrategy(n)}).fail(function(t){e.error("Failed to load view strategy ("+n.strategy+"). Details: "+t.message)}):this.executeStrategy(n),void 0):(this.bindAndShow(null,n),void 0)},compose:function(n,a,r,o){b++,o||(a=h.getSettings(function(){return a},n));var g=l(n);a.activeView=g.activeView,a.parent=n,a.triggerAttach=d,a.bindingContext=r,a.cacheViews&&!a.viewElements&&(a.viewElements=g.childElements),a.model?e.isString(a.model)?e.acquire(a.model).then(function(t){a.model=e.resolveObject(t),h.inject(a)}).fail(function(t){e.error("Failed to load composed module ("+a.model+"). Details: "+t.message)}):h.inject(a):a.view?(a.area=a.area||"partial",a.preserveContext=!0,t.locateView(a.view,a.area,a.viewElements).then(function(e){h.bindAndShow(e,a)})):this.bindAndShow(null,a)}},g.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,r,o){var l=h.getSettings(t,e);if(l.mode){var i=g.utils.domData.get(e,f);if(!i){var s=g.virtualElements.childNodes(e);i={},"inline"===l.mode?i.view=a.ensureSingleElement(s):"templated"===l.mode&&(i.parts=m(s)),g.virtualElements.emptyNode(e),g.utils.domData.set(e,f,i)}"inline"===l.mode?l.view=i.view.cloneNode(!0):"templated"===l.mode&&(l.parts=i.parts),l.preserveContext=!0}h.compose(e,l,o,!0)}},g.virtualElements.allowedBindings.compose=!0,h});