define(["durandal/system","jquery"],function(e,t){function n(e,t,n){if(n){var a=e.href.replace(/(javascript:|#).*$/,"");e.replace(a+"#"+t)}else e.hash="#"+t}var a=/^[#\/]|\s+$/g,r=/^\/+|\/+$/g,o=/msie [\w.]+/,g=/\/$/,l={interval:50,active:!1};return"undefined"!=typeof window&&(l.location=window.location,l.history=window.history),l.getHash=function(e){var t=(e||l).location.href.match(/#(.*)$/);return t?t[1]:""},l.getFragment=function(e,t){if(null==e)if(l._hasPushState||!l._wantsHashChange||t){e=l.location.pathname;var n=l.root.replace(g,"");e.indexOf(n)||(e=e.substr(n.length))}else e=l.getHash();return e.replace(a,"")},l.activate=function(n){l.active&&e.error("History has already been activated."),l.active=!0,l.options=e.extend({},{root:"/"},l.options,n),l.root=l.options.root,l._wantsHashChange=l.options.hashChange!==!1,l._wantsPushState=!!l.options.pushState,l._hasPushState=!!(l.options.pushState&&l.history&&l.history.pushState);var g=l.getFragment(),i=document.documentMode,s=o.exec(navigator.userAgent.toLowerCase())&&(!i||7>=i);l.root=("/"+l.root+"/").replace(r,"/"),s&&l._wantsHashChange&&(l.iframe=t('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,l.navigate(g,!1)),l._hasPushState?t(window).on("popstate",l.checkUrl):l._wantsHashChange&&"onhashchange"in window&&!s?t(window).on("hashchange",l.checkUrl):l._wantsHashChange&&(l._checkUrlInterval=setInterval(l.checkUrl,l.interval)),l.fragment=g;var d=l.location,p=d.pathname.replace(/[^\/]$/,"$&/")===l.root;if(l._wantsHashChange&&l._wantsPushState){if(!l._hasPushState&&!p)return l.fragment=l.getFragment(null,!0),l.location.replace(l.root+l.location.search+"#"+l.fragment),!0;l._hasPushState&&p&&d.hash&&(this.fragment=l.getHash().replace(a,""),this.history.replaceState({},document.title,l.root+l.fragment+d.search))}return l.options.silent?void 0:l.loadUrl()},l.deactivate=function(){t(window).off("popstate",l.checkUrl).off("hashchange",l.checkUrl),clearInterval(l._checkUrlInterval),l.active=!1},l.checkUrl=function(){var e=l.getFragment();return e===l.fragment&&l.iframe&&(e=l.getFragment(l.getHash(l.iframe))),e===l.fragment?!1:(l.iframe&&l.navigate(e,!1),l.loadUrl(),void 0)},l.loadUrl=function(e){var t=l.fragment=l.getFragment(e);return l.options.routeHandler?l.options.routeHandler(t):!1},l.navigate=function(t,a){if(!l.active)return!1;if(void 0===a?a={trigger:!0}:e.isBoolean(a)&&(a={trigger:a}),t=l.getFragment(t||""),l.fragment!==t){l.fragment=t;var r=l.root+t;if(l._hasPushState)l.history[a.replace?"replaceState":"pushState"]({},document.title,r);else{if(!l._wantsHashChange)return l.location.assign(r);n(l.location,t,a.replace),l.iframe&&t!==l.getFragment(l.getHash(l.iframe))&&(a.replace||l.iframe.document.open().close(),n(l.iframe.location,t,a.replace))}return a.trigger?l.loadUrl(t):void 0}},l.navigateBack=function(){l.history.back()},l});