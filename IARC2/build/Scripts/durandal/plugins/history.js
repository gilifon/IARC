define(["durandal/system","jquery"],function(e,t){function n(e,t,n){if(n){var a=e.href.replace(/(javascript:|#).*$/,"");e.replace(a+"#"+t)}else e.hash="#"+t}var a=/^[#\/]|\s+$/g,r=/^\/+|\/+$/g,o=/msie [\w.]+/,l=/\/$/,g={interval:50,active:!1};return"undefined"!=typeof window&&(g.location=window.location,g.history=window.history),g.getHash=function(e){var t=(e||g).location.href.match(/#(.*)$/);return t?t[1]:""},g.getFragment=function(e,t){if(null==e)if(g._hasPushState||!g._wantsHashChange||t){e=g.location.pathname;var n=g.root.replace(l,"");e.indexOf(n)||(e=e.substr(n.length))}else e=g.getHash();return e.replace(a,"")},g.activate=function(n){g.active&&e.error("History has already been activated."),g.active=!0,g.options=e.extend({},{root:"/"},g.options,n),g.root=g.options.root,g._wantsHashChange=g.options.hashChange!==!1,g._wantsPushState=!!g.options.pushState,g._hasPushState=!!(g.options.pushState&&g.history&&g.history.pushState);var l=g.getFragment(),i=document.documentMode,s=o.exec(navigator.userAgent.toLowerCase())&&(!i||7>=i);g.root=("/"+g.root+"/").replace(r,"/"),s&&g._wantsHashChange&&(g.iframe=t('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,g.navigate(l,!1)),g._hasPushState?t(window).on("popstate",g.checkUrl):g._wantsHashChange&&"onhashchange"in window&&!s?t(window).on("hashchange",g.checkUrl):g._wantsHashChange&&(g._checkUrlInterval=setInterval(g.checkUrl,g.interval)),g.fragment=l;var d=g.location,p=d.pathname.replace(/[^\/]$/,"$&/")===g.root;if(g._wantsHashChange&&g._wantsPushState){if(!g._hasPushState&&!p)return g.fragment=g.getFragment(null,!0),g.location.replace(g.root+g.location.search+"#"+g.fragment),!0;g._hasPushState&&p&&d.hash&&(this.fragment=g.getHash().replace(a,""),this.history.replaceState({},document.title,g.root+g.fragment+d.search))}return g.options.silent?void 0:g.loadUrl()},g.deactivate=function(){t(window).off("popstate",g.checkUrl).off("hashchange",g.checkUrl),clearInterval(g._checkUrlInterval),g.active=!1},g.checkUrl=function(){var e=g.getFragment();return e===g.fragment&&g.iframe&&(e=g.getFragment(g.getHash(g.iframe))),e===g.fragment?!1:(g.iframe&&g.navigate(e,!1),g.loadUrl(),void 0)},g.loadUrl=function(e){var t=g.fragment=g.getFragment(e);return g.options.routeHandler?g.options.routeHandler(t):!1},g.navigate=function(t,a){if(!g.active)return!1;if(void 0===a?a={trigger:!0}:e.isBoolean(a)&&(a={trigger:a}),t=g.getFragment(t||""),g.fragment!==t){g.fragment=t;var r=g.root+t;if(g._hasPushState)g.history[a.replace?"replaceState":"pushState"]({},document.title,r);else{if(!g._wantsHashChange)return g.location.assign(r);n(g.location,t,a.replace),g.iframe&&t!==g.getFragment(g.getHash(g.iframe))&&(a.replace||g.iframe.document.open().close(),n(g.iframe.location,t,a.replace))}return a.trigger?g.loadUrl(t):void 0}},g.navigateBack=function(){g.history.back()},g});