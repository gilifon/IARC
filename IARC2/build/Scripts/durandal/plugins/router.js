define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(e,t,n,a,r,o,l,g){function i(e){return e=e.replace(v,"\\$&").replace(h,"(?:$1)?").replace(u,function(e,t){return t?e:"([^/]+)"}).replace(w,"(.*?)"),new RegExp("^"+e+"$")}function s(e){var t=e.indexOf(":"),n=t>0?t-1:e.length;return e.substring(0,n)}function d(e){return e.router&&e.router.loadUrl}function p(e,t){return-1!==e.indexOf(t,e.length-t.length)}function c(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var n=0,a=e.length;a>n;n++)if(e[n]!=t[n])return!1;return!0}var m,L,h=/\((.*?)\)/g,u=/(\(\?)?:\w+/g,w=/\*\w+/g,v=/[\-{}\[\]+?.,\\\^$|#\s]/g,f=/\/$/,b=function(){function r(t,n){e.log("Navigation Complete",t,n);var a=e.getModuleId(B);a&&j.trigger("router:navigation:from:"+a),B=t,M=n;var r=e.getModuleId(B);r&&j.trigger("router:navigation:to:"+r),d(t)||j.updateDocumentTitle(t,n),L.explicitNavigation=!1,L.navigatingBack=!1,j.trigger("router:navigation:complete",t,n,j)}function g(t,n){e.log("Navigation Cancelled"),j.activeInstruction(M),M&&j.navigate(M.fragment,!1),H(!1),L.explicitNavigation=!1,L.navigatingBack=!1,j.trigger("router:navigation:cancelled",t,n,j)}function h(t){e.log("Navigation Redirecting"),H(!1),L.explicitNavigation=!1,L.navigatingBack=!1,j.navigate(t,{trigger:!0,replace:!0})}function u(e,t,n){L.navigatingBack=!L.explicitNavigation&&B!=n.fragment,j.trigger("router:route:activating",t,n,j),e.activateItem(t,n.params).then(function(a){if(a){var o=B;r(t,n),d(t)&&x({router:t.router,fragment:n.fragment,queryString:n.queryString}),o==t&&j.attached()}else e.settings.lifecycleData&&e.settings.lifecycleData.redirect?h(e.settings.lifecycleData.redirect):g(t,n);m&&(m.resolve(),m=null)})}function w(t,n,a){var r=j.guardRoute(n,a);r?r.then?r.then(function(r){r?e.isString(r)?h(r):u(t,n,a):g(n,a)}):e.isString(r)?h(r):u(t,n,a):g(n,a)}function v(e,t,n){j.guardRoute?w(e,t,n):u(e,t,n)}function y(e){return M&&M.config.moduleId==e.config.moduleId&&B&&(B.canReuseForRoute&&B.canReuseForRoute.apply(B,e.params)||B.router&&B.router.loadUrl)}function _(){if(!H()){var t=R.shift();if(R=[],t){if(t.router){var a=t.fragment;return t.queryString&&(a+="?"+t.queryString),t.router.loadUrl(a),void 0}H(!0),j.activeInstruction(t),y(t)?v(n.create(),B,t):e.acquire(t.config.moduleId).then(function(n){var a=e.resolveObject(n);v(T,a,t)}).fail(function(n){e.error("Failed to load routed module ("+t.config.moduleId+"). Details: "+n.message)})}}}function x(e){R.unshift(e),_()}function S(e,t,n){for(var a=e.exec(t).slice(1),r=0;r<a.length;r++){var o=a[r];a[r]=o?decodeURIComponent(o):null}var l=j.parseQueryString(n);return l&&a.push(l),{params:a,queryParams:l}}function k(t){j.trigger("router:route:before-config",t,j),e.isRegExp(t)?t.routePattern=t.route:(t.title=t.title||j.convertRouteToTitle(t.route),t.moduleId=t.moduleId||j.convertRouteToModuleId(t.route),t.hash=t.hash||j.convertRouteToHash(t.route),t.routePattern=i(t.route)),j.trigger("router:route:after-config",t,j),j.routes.push(t),j.route(t.routePattern,function(e,n){var a=S(t.routePattern,e,n);x({fragment:e,queryString:n,config:t,params:a.params,queryParams:a.queryParams})})}function C(t){if(e.isArray(t.route))for(var n=0,a=t.route.length;a>n;n++){var r=e.extend({},t);r.route=t.route[n],n>0&&delete r.nav,k(r)}else k(t);return j}function A(e){e.isActive||(e.isActive=l.computed(function(){var t=T();return t&&t.__moduleId__==e.moduleId}))}var B,M,R=[],H=l.observable(!1),T=n.create(),j={handlers:[],routes:[],navigationModel:l.observableArray([]),activeItem:T,isNavigating:l.computed(function(){var e=T(),t=H(),n=e&&e.router&&e.router!=j&&e.router.isNavigating()?!0:!1;return t||n}),activeInstruction:l.observable(null),__router__:!0};return a.includeIn(j),T.settings.areSameItem=function(e,t,n,a){return e==t?c(n,a):!1},j.parseQueryString=function(e){var t,n;if(!e)return null;if(n=e.split("&"),0==n.length)return null;t={};for(var a=0;a<n.length;a++){var r=n[a];if(""!==r){var o=r.split("=");t[o[0]]=o[1]&&decodeURIComponent(o[1].replace(/\+/g," "))}}return t},j.route=function(e,t){j.handlers.push({routePattern:e,callback:t})},j.loadUrl=function(t){var n=j.handlers,a=null,r=t,l=t.indexOf("?");if(-1!=l&&(r=t.substring(0,l),a=t.substr(l+1)),j.relativeToParentRouter){var g=this.parent.activeInstruction();r=g.params.join("/"),r&&"/"==r[0]&&(r=r.substr(1)),r||(r=""),r=r.replace("//","/").replace("//","/")}r=r.replace(f,"");for(var i=0;i<n.length;i++){var s=n[i];if(s.routePattern.test(r))return s.callback(r,a),!0}return e.log("Route Not Found"),j.trigger("router:route:not-found",t,j),M&&o.navigate(M.fragment,{trigger:!1,replace:!0}),L.explicitNavigation=!1,L.navigatingBack=!1,!1},j.updateDocumentTitle=function(e,n){n.config.title?document.title=t.title?n.config.title+" | "+t.title:n.config.title:t.title&&(document.title=t.title)},j.navigate=function(e,t){return e&&-1!=e.indexOf("://")?(window.location.href=e,!0):(L.explicitNavigation=!0,o.navigate(e,t))},j.navigateBack=function(){o.navigateBack()},j.attached=function(){setTimeout(function(){H(!1),j.trigger("router:navigation:attached",B,M,j),_()},10)},j.compositionComplete=function(){j.trigger("router:navigation:composition-complete",B,M,j)},j.convertRouteToHash=function(e){if(j.relativeToParentRouter){var t=j.parent.activeInstruction(),n=t.config.hash+"/"+e;return o._hasPushState&&(n="/"+n),n=n.replace("//","/").replace("//","/")}return o._hasPushState?e:"#"+e},j.convertRouteToModuleId=function(e){return s(e)},j.convertRouteToTitle=function(e){var t=s(e);return t.substring(0,1).toUpperCase()+t.substring(1)},j.map=function(t,n){if(e.isArray(t)){for(var a=0;a<t.length;a++)j.map(t[a]);return j}return e.isString(t)||e.isRegExp(t)?(n?e.isString(n)&&(n={moduleId:n}):n={},n.route=t):n=t,C(n)},j.buildNavigationModel=function(t){var n=[],a=j.routes;t=t||100;for(var r=0;r<a.length;r++){var o=a[r];o.nav&&(e.isNumber(o.nav)||(o.nav=t),A(o),n.push(o))}return n.sort(function(e,t){return e.nav-t.nav}),j.navigationModel(n),j},j.mapUnknownRoutes=function(t,n){var a="*catchall",r=i(a);return j.route(r,function(l,g){var i=S(r,l,g),s={fragment:l,queryString:g,config:{route:a,routePattern:r},params:i.params,queryParams:i.queryParams};if(t)if(e.isString(t))s.config.moduleId=t,n&&o.navigate(n,{trigger:!1,replace:!0});else if(e.isFunction(t)){var d=t(s);if(d&&d.then)return d.then(function(){j.trigger("router:route:before-config",s.config,j),j.trigger("router:route:after-config",s.config,j),x(s)}),void 0}else s.config=t,s.config.route=a,s.config.routePattern=r;else s.config.moduleId=l;j.trigger("router:route:before-config",s.config,j),j.trigger("router:route:after-config",s.config,j),x(s)}),j},j.reset=function(){return M=B=void 0,j.handlers=[],j.routes=[],j.off(),delete j.options,j},j.makeRelative=function(t){return e.isString(t)&&(t={moduleId:t,route:t}),t.moduleId&&!p(t.moduleId,"/")&&(t.moduleId+="/"),t.route&&!p(t.route,"/")&&(t.route+="/"),t.fromParent&&(j.relativeToParentRouter=!0),j.on("router:route:before-config").then(function(e){t.moduleId&&(e.moduleId=t.moduleId+e.moduleId),t.route&&(e.route=""===e.route?t.route.substring(0,t.route.length-1):t.route+e.route)}),j},j.createChildRouter=function(){var e=b();return e.parent=j,e},j};return L=b(),L.explicitNavigation=!1,L.navigatingBack=!1,L.activate=function(t){return e.defer(function(n){if(m=n,L.options=e.extend({routeHandler:L.loadUrl},L.options,t),o.activate(L.options),o._hasPushState)for(var a=L.routes,r=a.length;r--;){var l=a[r];l.hash=l.hash.replace("#","")}g(document).delegate("a","click",function(e){if(L.explicitNavigation=!0,o._hasPushState&&!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t=g(this).attr("href"),n=this.protocol+"//";(!t||"#"!==t.charAt(0)&&t.slice(n.length)!==n)&&(e.preventDefault(),o.navigate(t))}})}).promise()},L.deactivate=function(){o.deactivate()},L.install=function(){l.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,a,o){var g=l.utils.unwrapObservable(t())||{};if(g.__router__)g={model:g.activeItem(),attached:g.attached,compositionComplete:g.compositionComplete,activate:!1};else{var i=l.utils.unwrapObservable(g.router||a.router)||L;g.model=i.activeItem(),g.attached=i.attached,g.compositionComplete=i.compositionComplete,g.activate=!1}r.compose(e,g,o)}},l.virtualElements.allowedBindings.router=!0},L});